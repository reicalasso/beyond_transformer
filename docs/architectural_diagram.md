# Neural State Machine Architectural Diagram

This document presents the architectural diagram of the Neural State Machine, defining the forward/backward flow and interactions between memory, attention, and state variables.

## 1. High-Level Module Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Neural State Machine (NSM)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐       │
│  │   Input Layer   │────▶│Token-to-State   │────▶│  Hybrid         │       │
│  │ (Tokenization,  │     │    Router       │     │  Attention      │       │
│  │Embedding, etc.) │     │                 │     │                 │       │
│  └─────────────────┘     └─────────────────┘     └─────────────────┘       │
│                                    │                         │              │
│                                    ▼                         ▼              │
│                          ┌─────────────────┐     ┌─────────────────┐       │
│                          │   State         │◀───▶│  State          │       │
│                          │   Manager       │     │  Propagator     │       │
│                          │                 │     │                 │       │
│                          └─────────────────┘     └─────────────────┘       │
│                                    │                         │              │
│                                    ▼                         ▼              │
│                          ┌─────────────────────────────────────────┐       │
│                          │        Output Layer                     │       │
│                          │  (Classification, Generation, etc.)     │       │
│                          └─────────────────────────────────────────┘       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 2. Detailed Component Architecture

### 2.1 Token-to-State Router Module

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Token-to-State Router                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Input Tokens                Routing Mechanism              Routed Tokens   │
│  [batch, seq_len,         ┌─────────────────────┐          [batch, num_states, │
│   token_dim]              │                     │           state_dim]      │
│  ┌─────────────┐          │  Multi-head Linear  │          ┌─────────────┐  │
│  │             │─────────▶│    Projection       │─────────▶│             │  │
│  │   Tokens    │          │                     │          │ Routed      │  │
│  │             │          └─────────────────────┘          │ Tokens      │  │
│  └─────────────┘                    │                      └─────────────┘  │
│                                     ▼                                       │
│                           ┌─────────────────────┐                           │
│                           │    Softmax          │                           │
│                           │   (Attention        │                           │
│                           │    Weights)         │                           │
│                           └─────────────────────┘                           │
│                                     │                                       │
│                                     ▼                                       │
│                           ┌─────────────────────┐                           │
│                           │  Dimension          │                           │
│                           │  Projection         │                           │
│                           └─────────────────────┘                           │
│                                     │                                       │
│                                     ▼                                       │
│                          Routing Weights                                    │
│                         [batch, seq_len,                                    │
│                          num_states]                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Hybrid Attention Module

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Hybrid Attention                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  States                    Attention Computation           Attended Tokens  │
│  [batch, num_states,      ┌─────────────────────┐         [batch, num_states,│
│   state_dim]              │                     │          state_dim]      │
│  ┌─────────────┐          │  State Projection   │          ┌─────────────┐  │
│  │             │─────────▶│                     │────┐     │             │  │
│  │   States    │          └─────────────────────┘    │     │ Attended    │  │
│  │             │                                     │     │ Tokens      │  │
│  └─────────────┘                                     │     └─────────────┘  │
│            │                                         │                      │
│            │                                         ▼                      │
│            │                               ┌─────────────────────┐        │
│            │                               │  Token Projection   │        │
│            │                               │                     │        │
│            │                               └─────────────────────┘        │
│            │                                         │                      │
│            ▼                                         ▼                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                   Attention Scoring                                 │   │
│  │            (States attend to Tokens)                                │   │
│  │         Q=States, K=Tokens, V=Tokens                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     ▼                                       │
│                           ┌─────────────────────┐                           │
│                           │    Softmax          │                           │
│                           │   (Attention        │                           │
│                           │    Weights)         │                           │
│                           └─────────────────────┘                           │
│                                     │                                       │
│                                     ▼                                       │
│                           ┌─────────────────────┐                           │
│                           │  Apply Attention    │                           │
│                           │   (Weighted Sum)    │                           │
│                           └─────────────────────┘                           │
│                                     │                                       │
│                                     ▼                                       │
│                           ┌─────────────────────┐                           │
│                           │  Output Projection  │                           │
│                           └─────────────────────┘                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 State Manager Module

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           State Manager                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                        State Storage                                │    │
│  │  ┌──────────────────────────────────────────────────────────────┐   │    │
│  │  │  State Nodes (Parameters)                                    │   │    │
│  │  │  [max_states, state_dim]                                     │   │    │
│  │  └──────────────────────────────────────────────────────────────┘   │    │
│  │                                                                     │    │
│  │  ┌──────────────────────────────────────────────────────────────┐   │    │
│  │  │  Active State Mask (Buffer)                                  │   │    │
│  │  │  [max_states] (Boolean)                                      │   │    │
│  │  └──────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                         │
│                                    ▼                                         │
│                    ┌─────────────────────────────┐                           │
│                    │  Importance Scoring         │                           │
│                    │  [max_states] (Parameters)  │                           │
│                    └─────────────────────────────┘                           │
│                                    │                                         │
│                                    ▼                                         │
│                    ┌─────────────────────────────┐                           │
│                    │  Sigmoid Activation         │                           │
│                    └─────────────────────────────┘                           │
│                                    │                                         │
│                                    ▼                                         │
│                        Importance Scores                                   │
│                       [max_states] (0-1)                                   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      Management Operations                          │    │
│  │  ┌──────────────────────────────────────────────────────────────┐   │    │
│  │  │  Dynamic Allocation                                          │   │    │
│  │  │  - Find inactive slots                                       │   │    │
│  │  │  - Activate states                                           │   │    │
│  │  │  - Initialize new states                                     │   │    │
│  │  └──────────────────────────────────────────────────────────────┘   │    │
│  │                                                                     │    │
│  │  ┌──────────────────────────────────────────────────────────────┐   │    │
│  │  │  Dynamic Pruning                                             │   │    │
│  │  │  - Evaluate importance scores                                │   │    │
│  │  │  - Deactivate low-importance states                          │   │    │
│  │  └──────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.4 State Propagator Module

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         State Propagator                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Previous States         Gating Mechanism          New Inputs               │
│  [batch, num_states,    ┌─────────────────────┐    [batch, num_states,      │
│   state_dim]            │                     │     state_dim]              │
│  ┌─────────────┐        │  Gate Computations  │     ┌─────────────┐         │
│  │             │───────▶│                     │◀───▶│             │         │
│  │ Prev States │        │  (Reset, Update,    │     │ New Inputs  │         │
│  │             │        │   Forget, etc.)     │     │             │         │
│  └─────────────┘        │                     │     └─────────────┘         │
│                         └─────────────────────┘                             │
│                                    │                                        │
│                                    ▼                                        │
│                          ┌─────────────────────┐                           │
│                          │  Candidate State    │                           │
│                          │   Computation       │                           │
│                          └─────────────────────┘                           │
│                                    │                                        │
│                                    ▼                                        │
│                          ┌─────────────────────┐                           │
│                          │  State Update       │                           │
│                          │   Formula           │                           │
│                          └─────────────────────┘                           │
│                                    │                                        │
│                                    ▼                                        │
│                         Updated States                                     │
│                        [batch, num_states,                                 │
│                         state_dim]                                         │
│                                    │                                        │
│                                    ▼                                        │
│                    (Optional) State-to-State Communication                  │
│                         ┌─────────────────────┐                           │
│                         │  Multi-head         │                           │
│                         │  Attention          │                           │
│                         └─────────────────────┘                           │
│                                    │                                        │
│                                    ▼                                        │
│                         ┌─────────────────────┐                           │
│                         │  Residual +         │                           │
│                         │  Layer Norm         │                           │
│                         └─────────────────────┘                           │
│                                    │                                        │
│                                    ▼                                        │
│                        Final Updated States                                │
│                       [batch, num_states,                                  │
│                        state_dim]                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 3. Complete Architectural Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Complete Neural State Machine Flow                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Input Sequence                                                             │
│  [batch, seq_len, token_dim]                                                │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────┐                                                            │
│  │   Input     │                                                            │
│  │ Processing  │                                                            │
│  └─────────────┘                                                            │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │              Processing Loop (for each token/input)                 │    │
│  │ ┌─────────────────────────────────────────────────────────────────┐ │    │
│  │ │ Token-to-State Router                                           │ │    │
│  │ │                                                                 │ │    │
│  │ │ Tokens ──────┐                                                  │ │    │
│  │ │              ▼                                                  │ │    │
│  │ │    ┌─────────────────┐    Routed Tokens    ┌─────────────────┐  │ │    │
│  │ │    │  Multi-head     │───────────────────▶│  Dimension      │  │ │    │
│  │ │    │  Projection     │                    │  Projection     │  │ │    │
│  │ │    └─────────────────┘                    └─────────────────┘  │ │    │
│  │ │              │                                    │              │ │    │
│  │ │              ▼                                    ▼              │ │    │
│  │ │    ┌─────────────────┐                   ┌─────────────────┐    │ │    │
│  │ │    │    Softmax      │                   │   States from   │    │ │    │
│  │ │    │ (Routing Weights)                   │   StateManager  │    │ │    │
│  │ │    └─────────────────┘                   └─────────────────┘    │ │    │
│  │ │              │                                    │              │ │    │
│  │ │              ▼                                    ▼              │ │    │
│  │ │    ┌─────────────────────────────────────────────────────────┐  │ │    │
│  │ │    │                   Hybrid Attention                      │  │ │    │
│  │ │    │                                                         │  │ │    │
│  │ │    │ States ──┐    ┌─────────────────┐                       │  │ │    │
│  │ │    │          ▼    │                 │    Attended Tokens    │  │ │    │
│  │ │    │ ┌─────────────┤  Attention      │──────────────────────▶│  │ │    │
│  │ │    │ │             │  Computation    │                       │  │ │    │
│  │ │    │ │ Tokens ────▶│                 │                       │  │ │    │
│  │ │    │ └─────────────┤                 │                       │  │ │    │
│  │ │    │               └─────────────────┘                       │  │ │    │
│  │ │    └─────────────────────────────────────────────────────────┘  │ │    │
│  │ │                                 │                                │ │    │
│  │ │                                 ▼                                │ │    │
│  │ │                   ┌─────────────────────────┐                    │ │    │
│  │ │                   │    State Propagator     │                    │ │    │
│  │ │                   │                         │                    │ │    │
│  │ │    Prev States ──▶│  Gated State Updates    │◀── Attended Tokens │ │    │
│  │ │                   │                         │                    │ │    │
│  │ │                   └─────────────────────────┘                    │ │    │
│  │ │                                 │                                │ │    │
│  │ │                                 ▼                                │ │    │
│  │ │                   ┌─────────────────────────┐                    │ │    │
│  │ │                   │  State-to-State Comm.   │                    │ │    │
│  │ │                   └─────────────────────────┘                    │ │    │
│  │ │                                 │                                │ │    │
│  │ │                                 ▼                                │ │    │
│  │ │                         Updated States                          │ │    │
│  │ │                                                                 │ │    │
│  │ │          ┌────────────────────────────────────────────┐         │ │    │
│  │ │          │          State Manager                     │         │ │    │
│  │ │          │                                            │         │ │    │
│  │ │          │  ┌─────────────────────────────────────┐   │         │ │    │
│  │ │          │  │  Dynamic Allocation/Pruning         │   │         │ │    │
│  │ │          │  │                                     │   │         │ │    │
│  │ │          │  │  Importance Score Updates           │◀──┘         │ │    │
│  │ │          │  └─────────────────────────────────────┘             │ │    │
│  │ │          └─────────────────────────────────────────────────────┘ │ │    │
│  │ └─────────────────────────────────────────────────────────────────┘ │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────┐                                                        │
│  │  Output Layer   │                                                        │
│  │ (Pooling,       │                                                        │
│  │  Projection,    │                                                        │
│  │  etc.)          │                                                        │
│  └─────────────────┘                                                        │
│         │                                                                   │
│         ▼                                                                   │
│    Final Output                                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```